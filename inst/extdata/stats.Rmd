---
title: "Statistics"
output:
  tufte::tufte_handout:
    toc: TRUE
    keep_tex: FALSE
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
  - \usepackage{float}
  - \floatplacement{figure}{H}
  - \makeatletter\renewcommand*{\fps@figure}{H}\makeatother
params:
  dev: TRUE
  package_dir: "."
editor_options: 
  chunk_output_type: console
---


```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
fhi::DashboardInitialiseOpinionated("sykdomspuls",
                                    PACKAGE_DIR=params$package_dir,
                                    FORCE_DEV_PACKAGE_LOAD = params$dev,
                                    SILENT=TRUE)

suppressMessages(library(data.table))
suppressMessages(library(ggplot2))
suppressMessages(library(lubridate))
suppressMessages(library(kableExtra))
suppressMessages(library(fhiplot))

data <- AnalyseStats1()
pd <- data[["alert_summary"]]
resYearLine <- data[["resYearLine"]]
resYearLineMunicip <- data[["resYearLineMunicip"]]




NorwayScale <- function(x, ...){
  arguments <- list(...)
  for (i in seq_along(arguments)) {
    if(names(arguments)[[i]]=="nsmall"){
      x <- round(x,arguments[[i]])
    }
  }
    
  retval <- format(x, ..., big.mark = ".", decimal.mark = 
",", scientific = FALSE) 
  retval <- stringr::str_replace_all(retval," ","")
  retval <- stringr::str_replace_all(retval,"NaN","")
  #retval <- paste0(" ",retval)
  return(retval)
}


alertChartByYear <- function(alerts){



  return (
   ggplot(alerts[!grepl("emerg", tag, fixed=TRUE),.N, by=.(floor_date(date, unit="year"), tag)]) +
     geom_col(aes(x=floor_date,y=N, fill=tag)) +
     theme_fhi_lines() +
     xlab("Year") +
     scale_fill_brewer(palette="Spectral")
  )
}


plotZscore <- function(data){
  return ( 
    ggplot(data) +
      geom_histogram(aes(x=zscore, y=..density..,
                         fill="Z-scores from data", colour="Z-scores from data")) +
      stat_function(fun = dnorm, n = 1001, args = list(mean = 0, sd = 1), 
                    aes(fill="Standard Normal Distribution",
                        colour="Standard Normal Distribution"),size=1) + 
      xlim(-7, 7) + 
      scale_fill_manual("Legend", values=c(fhiplot::vals$cols$primary[["B2"]],
                                           fhiplot::vals$cols$primary[["B1"]])) +
      scale_colour_manual("Legend", values=c(fhiplot::vals$cols$primary[["B2"]],
                                             fhiplot::vals$cols$primary[["B1"]]), guide="none") +
     theme_fhi_lines()
  )

}



```

```
# Statistical properties
```{r echo=FALSE, results='asis', paged.print=TRUE }

cat("Regression analysis failed for ", nrow(resYearLine[failed == TRUE]) + nrow(resYearLineMunicip[failed == TRUE]), "weeks")
cat("  \n \\medskip  \n ")

 if(nrow(resYearLine[failed == TRUE]) > 0){

    cat('<div class = "row">\n <div class = "col-md-6"> \n')
    table <- resYearLine[failed == TRUE, .N, by=.(location)][data.table(fhidata::norway_locations_current), on=.(location=county_code), nomatch=0]
    cat('\\begin{minipage}[t]{0.5\\textwidth}')
    cat("Weeks when regression failed by county \n")
    k <- knitr::kable(table[order(-N), .(county_name, N)], "latex",
                      booktabs = T,
                      align = "c",
                      linesep = ""
                      )
    print(k)
    cat('\\end{minipage} \n \\begin{minipage}[t]{0.5\\textwidth}')
    cat("Weeks when regression failed by condition \n")
    k <- knitr::kable(resYearLine[failed == TRUE, .N, by=.(tag)][order(-N)], "latex",
                      booktabs = T,
                      align = "c",
                      linesep = ""
                      )
   print(k)
   cat('\\end{minipage}')
 }
 if(nrow(resYearLineMunicip[failed == TRUE]) > 0){
    table <- resYearLineMunicip[failed == TRUE, .N, by=.(location)][data.table(fhidata::norway_locations_current), on=.(location=municip_code), nomatch=0]



    n_rows <- nrow(table)
    if(n_rows > 35){
       n_rows <- 35
    }
    cat('\\begin{minipage}[t]{0.5\\textwidth}')
    cat("Weeks when regression failed by muncipality")
    if(n_rows == 35){
       cat("(top 35)\n")
    }
    k <- knitr::kable(table[order(-N), .(municip_name, N)][1:n_rows], "latex",
                      booktabs = T,
                      align = "c",
                      linesep = ""
                      )
    print(k)

    cat('\\end{minipage} \n \\begin{minipage}[t]{0.5\\textwidth}')
    cat("Weeks when regression failed by condition \n")
    k <- knitr::kable(resYearLineMunicip[failed == TRUE, .N, by=.(tag)][order(-N)], "latex",
                      booktabs = T,
                      align = "c",
                      linesep = ""
                      )
   print(k)
   cat('\\end{minipage}')

 }


```
\newpage

## Z-scores from regional Level
```{r echo=FALSE, fig.fullwidth=TRUE, fig.height=11.69*0.35, fig.width=8.27*0.7, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
cat(tufte::margin_note(glue::glue('Comparing the observed z-scores from the regression model with a standard normal for counties')))
cat("\\medskip")
plotZscore(resYearLine)

n_tot = nrow(resYearLine)

cat("Observed ", nrow(resYearLine[zscore >=2]), " alerts with z>2 compared to  an expected ", round((1 - pnorm(2, 0, 1)) * n_tot, 0)," and we observed " , nrow(resYearLine[zscore >=4]), " alerts with z>4 compared to an expected" , round((1 - pnorm(4, 0, 1)) * n_tot,0), ".")

```
\newpage

## Z-scores from municipal level
```{r echo=FALSE, fig.fullwidth=TRUE, fig.height=11.69*0.35, fig.width=8.27*0.7, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
cat(tufte::margin_note(glue::glue('Comparing the observed z-scores from the regression model with a standard normal for municipalties')))
cat("\\medskip")
plotZscore(resYearLineMunicip)

n_tot = nrow(resYearLineMunicip)
cat("Observed ", nrow(resYearLineMunicip[zscore >=2]), " alerts with z>2 compared to  an expected ", round((1 - pnorm(2, 0, 1)) * n_tot, 0)," and we observed " , nrow(resYearLineMunicip[zscore >=4]), " alerts with z>4 compared to an expected" , round((1 - pnorm(4, 0, 1)) * n_tot,0), ".")
```
\newpage

# Alerts by year (z > 2)

## Alerts on a national level
```{r echo=FALSE, fig.fullwidth=TRUE, fig.height=11.69*0.35, fig.width=8.27*0.7, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
cat(tufte::margin_note(glue::glue('Number of alerts (z>2) by type for the whole of Norway by year. ')))
 
alertChartByYear(resYearLine[x_alerts2 == TRUE & location == "Norge"])

```
\newpage

## Alerts on regional level
```{r echo=FALSE, fig.fullwidth=TRUE, fig.height=11.69*0.35, fig.width=8.27*0.7, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
 cat(tufte::margin_note(glue::glue('Number of alerts (z>2) by type and region in Norway by year.' )))
alertChartByYear(resYearLine[x_alerts2 == TRUE & location != "Norge"])
```
\newpage
## Alerts on municipal level
```{r echo=FALSE, fig.fullwidth=TRUE, fig.height=11.69*0.35, fig.width=8.27*0.7, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
 cat(tufte::margin_note(glue::glue('Number of alerts (z>2) by type and muncipaltiy in Norway by year.' ))) 
alertChartByYear(resYearLineMunicip[x_alerts2 == TRUE])
```
\newpage

# Alerts by year (z > 4)

## Alerts on a national level
```{r echo=FALSE, fig.fullwidth=TRUE, fig.height=11.69*0.35, fig.width=8.27*0.7, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
 cat(tufte::margin_note(glue::glue('Number of alerts (z>4) by type for the whole of Norway by year. ')))
alertChartByYear(resYearLine[x_alerts4 == TRUE & location == "Norge"])

```
\newpage

## Alerts on regional level
```{r echo=FALSE, fig.fullwidth=TRUE, fig.height=11.69*0.35, fig.width=8.27*0.7, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
 cat(tufte::margin_note(glue::glue('Number of alerts (z>4) by type and region in Norway by year.' )))
alertChartByYear(resYearLine[x_alerts4 == TRUE & location != "Norge"])
```

\newpage
## Alerts on municipal level
```{r echo=FALSE, fig.fullwidth=TRUE, fig.height=11.69*0.35, fig.width=8.27*0.7, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
 cat(tufte::margin_note(glue::glue('Number of alerts (z>4) by type and muncipaltiy in Norway by year.' )))
alertChartByYear(resYearLineMunicip[x_alerts4 == TRUE])
```


\newpage


# Number of alerts

```{r echo=FALSE, fig.fullwidth=TRUE, fig.height=11.69*0.65, fig.width=8.27*0.9, message=FALSE, warning=FALSE, paged.print=FALSE, results='asis'}
for(xtag in unique(pd$tag)){
  cat("  \n  \n ")
  cat("## ",xtag,"  \n")
  
  cat(tufte::margin_note(glue::glue('
                                    We compare the number of alerts ("\\# Alerts"), \
                                    number of cases ("\\# Cases"), and number of cases \
                                    greater than expected ("Cases>Expected") under two \
                                    different alert designations: a) Z-score>2, and b) Z-score>4
                                    ')))
  
  tabd <- pd[tag==xtag]
  tabd <- dcast.data.table(tabd, age+type~variable, value.var = c("meanAlertsN","meanCases","meanCasesOverT0"))
  setcolorder(tabd,
              c("age",
                "type",
                "meanAlertsN_x_alerts2_ge5cases",
                "meanAlertsN_x_alerts4_ge5cases",
                "meanCases_x_alerts2_ge5cases",
                "meanCases_x_alerts4_ge5cases",
                "meanCasesOverT0_x_alerts2_ge5cases",
                "meanCasesOverT0_x_alerts4_ge5cases"
                ))
  
  tabd[,meanAlertsN_x_alerts2_ge5cases:=NorwayScale(meanAlertsN_x_alerts2_ge5cases, nsmall=1)]
  tabd[,meanAlertsN_x_alerts4_ge5cases:=NorwayScale(meanAlertsN_x_alerts4_ge5cases, nsmall=1)]
  tabd[,meanCases_x_alerts2_ge5cases:=NorwayScale(meanCases_x_alerts2_ge5cases, nsmall=0)]
  tabd[,meanCases_x_alerts4_ge5cases:=NorwayScale(meanCases_x_alerts4_ge5cases, nsmall=0)]
  tabd[,meanCasesOverT0_x_alerts2_ge5cases:=NorwayScale(meanCasesOverT0_x_alerts2_ge5cases, nsmall=0)]
  tabd[,meanCasesOverT0_x_alerts4_ge5cases:=NorwayScale(meanCasesOverT0_x_alerts4_ge5cases, nsmall=0)]
  
  setnames(tabd,c(
    "Age","Geo",
    "Z>2","Z>4",
    "Z>2","Z>4",
    "Z>2","Z>4"
  ))
  
  k <- knitr::kable(tabd, "latex",
                    booktabs = T,
                    align = "c",
                    linesep = ""
                    ) %>%
    kableExtra::collapse_rows(1, latex_hline = "major", valign="top") %>%
    kableExtra::add_header_above(c(" " = 2, "# Alerts" = 2, "# Cases" = 2, "Cases>Expected"=2))

  print(k)
  

  cat(" \\newpage ")
}

```

